<?php
/**
 * Created by PhpStorm.
 * User: amdin
 * Date: 2017/9/8
 * Time: 11:48
 */
namespace Prj\Model;
class CouponFinal extends _ModelBase
{
    public function onInit()
    {
        $this->className = "Coupon";
        parent::onInit(); // TODO: Change the autogenerated stub
        $this->_tbName = "tb_coupon_final";
    }

    //优惠券统计
    public static function CouponFinalStat($where = ' WHERE 1="1"'){
        // 券
        $couponTbname = \Prj\Model\Coupon::getTbname();
        // 优惠券统计表
        $couponFinalTbname = self::getTbname();
        $sql = "SELECT 
                c.oid,
                c.typeCode,
                c.isFloat,
                c.amount,
                c.investAmount,
                c.createTime,
                cf.ymd,
                cf.purposeCode,
                cf.couponId,
                cf.title,
                max(cf.ymd) AS maxymd,
                min(cf.ymd) AS minymd,
                sum(cf.useCount) AS useCount,
                sum(cf.useCost) AS useCost
                FROM {$couponFinalTbname} AS cf
                LEFT JOIN {$couponTbname} AS c ON cf.couponId = c.oid
                {$where} GROUP BY cf.couponId";
        return $data = self::query($sql);

    }

    //优惠券统计表
    public static function couponFinalList($where){
        return self::getRecords('couponId,checkUsersNum,title,sum(leadCount) AS leadCount,sum(useCount) AS useCount,sum(useCost) AS useCost,sum(investAmount) AS investAmount,FORMAT(useCount/leadCount,2) AS `usage`,FORMAT(investAmount/useCost,2) AS `ROI`',$where,'groupby couponId');
    }

    // 使用详情
    public static function couponProductAndOrderInfo($couponId){
        $orderTbname = \Prj\Model\ZyBusiness\TradOrder::getTbname();
        $userConpon = \Prj\Model\ZyBusiness\UserCoupon::getRecords('*',['couponId'=>$couponId]);
        $ucId = array_column($userConpon,'ucId');
        $productTbname = \Prj\Model\Product::getTbname();
        if( empty($ucId) ){
            return [];
        }
        $sql = "SELECT
                o.orderNo,
                o.userId,
                o.productId,
                o.createTime AS ocreateTime,
                o.orderAmount,
                o.couponType,
                o.couponAmount,
                p.productName,
                p.interestTotal,
                p.durationPeriodDays
                FROM
                {$orderTbname} AS o 
                LEFT JOIN 
                {$productTbname} AS p 
                ON o.productId = p.productId
                WHERE o.userCouponId IN (".implode(',',$ucId).")";
        $data = self::query($sql);
        return $data;
//        print_r(\Prj\Model\ZyBusiness\TradOrder::getRecords());
    }
}
